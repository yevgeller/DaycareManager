@page "/attendance/checkin"
@using DaycareManager.Models
@using DaycareManager.Data
@using Microsoft.EntityFrameworkCore
@inject DaycareDbContext DbContext
@rendermode InteractiveServer

<PageTitle>Check-In / Check-Out</PageTitle>

<h1>Daily Attendance</h1>
<h3>@DateTime.Today.ToString("D")</h3>

@if (children == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <div class="row">
        @foreach (var child in children)
        {
            var myAttendances = childAttendance?.Where(a => a.ChildId == child.Id).OrderBy(a => a.CheckInTime).ToList();
            var lastAttendance = myAttendances?.LastOrDefault();
            var isCheckedIn = lastAttendance != null && lastAttendance.CheckOutTime == null;

            <div class="col-md-4 mb-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">@child.FirstName @child.LastName</h5>
                        
                        @if (isCheckedIn)
                        {
                            <button class="btn btn-warning mb-2" @onclick="() => CheckOut(child.Id)">Check Out</button>
                        }
                        else
                        {
                            <button class="btn btn-success mb-2" @onclick="() => CheckInChild(child.Id)">Check In..</button>
                        }

                        @if (myAttendances != null && myAttendances.Any())
                        {
                            <ul class="list-group list-group-flush mt-2">
                                @foreach (var att in myAttendances)
                                {
                                    <li class="list-group-item p-1">
                                        <small>
                                            <strong>In:</strong> @att.CheckInTime.ToShortTimeString()
                                            <br />
                                            @if (att.CheckOutTime != null)
                                            {
                                                <strong>Out:</strong> @att.CheckOutTime.Value.ToShortTimeString()
                                            }
                                        </small>
                                    </li>
                                }
                            </ul>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
}

@code {
    private List<Child>? children;
    private List<Attendance>? childAttendance;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        children = await DbContext.Children.ToListAsync();
        
        var today = DateTime.Today;
        childAttendance = await DbContext.Attendances
            .Where(a => a.CheckInTime >= today)
            .ToListAsync();
    }

    private async Task CheckInChild(int childId)
    {
        var attendance = new Attendance
        {
            ChildId = childId,
            CheckInTime = DateTime.Now
        };

        DbContext.Attendances.Add(attendance);
        await DbContext.SaveChangesAsync();
        await LoadData();
    }

    private async Task CheckOut(int childId)
    {
        var today = DateTime.Today;
        // Get the latest open attendance record for today
        var attendance = await DbContext.Attendances
            .Where(a => a.ChildId == childId && a.CheckInTime >= today && a.CheckOutTime == null)
            .OrderByDescending(a => a.CheckInTime)
            .FirstOrDefaultAsync();

        if (attendance != null)
        {
            attendance.CheckOutTime = DateTime.Now;
            await DbContext.SaveChangesAsync();
            await LoadData();
        }
    }
}
