@page "/classrooms/edit/{id:int}"
@using DaycareManager.Models
@using DaycareManager.Data
@using Microsoft.EntityFrameworkCore
@inject DaycareDbContext DbContext
@inject NavigationManager NavigationManager

<PageTitle>Edit Classroom</PageTitle>

<h1>Edit Classroom</h1>

<h4>Classroom</h4>
<hr />
@if (Classroom is null)
{
    <p><em>Loading...</em></p>
}
else
{
    <div class="row">
        <div class="col-md-6">
            <EditForm Model="Classroom" OnValidSubmit="UpdateClassroom" FormName="editClassroom" Enhance>
                <DataAnnotationsValidator />
                <ValidationSummary class="text-danger" />
                <InputNumber @bind-Value="Classroom.Id" hidden />
                
                <div class="mb-3">
                    <label for="number" class="form-label">Classroom Number/Name</label>
                    <InputText id="number" class="form-control" @bind-Value="Classroom.ClassroomNumber" />
                    <ValidationMessage For="() => Classroom.ClassroomNumber" class="text-danger" />
                </div>
                
                <div class="row mb-3">
                    <div class="col">
                        <label class="form-label fw-bold">Minimum Age: @Classroom.MinAgeMonths months</label>
                        <InputNumber @bind-Value="Classroom.MinAgeMonths" hidden />
                    </div>
                    <div class="col">
                        <label class="form-label fw-bold">Maximum Age: @Classroom.MaxAgeMonths months</label>
                        <InputNumber @bind-Value="Classroom.MaxAgeMonths" hidden />
                    </div>
                </div>

                <div class="mb-3">
                    <label for="capacity" class="form-label">Capacity</label>
                    <InputNumber id="capacity" class="form-control" @bind-Value="Classroom.Capacity" />
                    <ValidationMessage For="() => Classroom.Capacity" class="text-danger" />
                </div>
                
                <div class="mb-3">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                    <a href="/classrooms" class="btn btn-secondary">Back to List</a>
                </div>
            </EditForm>
        </div>
    </div>

    <hr class="my-4"/>

    <div class="row">
        <div class="col-md-12">
            <h3>Assigned Children (@Classroom.Children.Count)</h3>
            
            @if (Classroom.Children.Any())
            {
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Age</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var child in Classroom.Children)
                        {
                            <tr>
                                <td>@child.FirstName @child.LastName</td>
                                <td>@child.AgeDescription</td>
                                <td><a href="/children/edit/@child.Id">Edit</a></td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <p class="text-muted">No children currently assigned to this classroom.</p>
            }
        </div>
    </div>
}

@code {
    [Parameter]
    public int Id { get; set; }

    [SupplyParameterFromForm]
    public Classroom? Classroom { get; set; }

    protected override async Task OnInitializedAsync()
    {
        if (Classroom is null)
        {
            Classroom = await DbContext.Classrooms
                .Include(c => c.Children)
                .FirstOrDefaultAsync(m => m.Id == Id);

            if (Classroom is null)
            {
                NavigationManager.NavigateTo("notfound");
            }
        }
    }

    private async Task UpdateClassroom()
    {
        DbContext.Attach(Classroom!).State = EntityState.Modified;

        try
        {
            await DbContext.SaveChangesAsync();
        }
        catch (DbUpdateConcurrencyException)
        {
            if (!ClassroomExists(Classroom!.Id))
            {
                NavigationManager.NavigateTo("notfound");
            }
            else
            {
                throw;
            }
        }

        NavigationManager.NavigateTo("/classrooms");
    }

    private bool ClassroomExists(int id)
    {
        return DbContext.Classrooms.Any(e => e.Id == id);
    }
}
